---
- name: Update
  hosts: laptop
  tasks:
    - name: Dnf update
      tags: pkg
      ansible.builtin.dnf:
        name: '*'
        state: latest
        update_cache: yes
      become: yes
      when: ansible_distribution == "Fedora"
    - name: Apk update
      tags: pkg
      community.general.apk:
        upgrade: yes
        update_cache: yes
      become: yes
      when: ansible_distribution == "Alpine"
    - name: Cloned git update
      tags: git
      block:
        - name: Include git from latest
          ansible.builtin.include_role:
            name: git
            tasks_from: latest
        - name: Include build from latest
          ansible.builtin.include_role:
            name: build
            tasks_from: latest
    - name: Flatpak update
      tags: flatpak
      ansible.builtin.command:
        cmd: |
          flatpak --user update --assumeyes --noninteractive
    - name: Pip update
      tags: pip
      block:
        - name: Get outdated pip packages
          ansible.builtin.shell:
            cmd: |
              pip list --user --outdated --exclude ansible-core --exclude ansible-lint \
              | awk '{print $1}' \
              | tail -n +3
          register: pypi
        - name: Pip install
          ansible.builtin.pip:
            name: '{{ item }}'
            state: present
            executable: /usr/bin/pip
            extra_args: --user --upgrade
          with_items: '{{ pypi.stdout_lines }}'
